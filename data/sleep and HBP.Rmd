---
title: "Preparing the NHANES Data for the Replication of: Association between sleep duration on workdays and blood pressure in nonâ€‘overweight/obese population in NHANES: a public database research"
subtitle: "By Yingjie Su and published in Nature Scientific Reports"
author: "Amos Okutse, Brown University"
date: "  `r format(Sys.time(), '%d %B, %Y')` "
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \usepackage{fvextra}
- \usepackage{float}
- \usepackage{wrapfig}
- \usepackage{amsmath}
- \usepackage{threeparttable} %used to fix table with notes
- \usepackage{float}
- \usepackage{graphicx}
- \usepackage{microtype}
- \usepackage{setspace}
- \usepackage[font=singlespacing]{caption} #can change font here for captions here!!
- \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines, commandchars=\\\{\}}
- \singlespacing
fontsize: 10pt
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: false
    toc_depth: 4
    number_sections: false
    keep_md: false
link-citations: yes
colorlinks: yes
linkcolor: blue
urlcolor: blue
#bibliography: refs.bib
bibliostyle: apalike
editor_options: 
  markdown: 
    wrap: 72
---

## Introduction
In this sample, we are interested in replicating Table 1 in the paper by Su et al. (2022) using data from the NHANES database. We will start by first loading some of the packages we will be using in our data extraction as well as replication of the table.

```{r warning=FALSE, message=FALSE}
library(nhanesA)
library(knitr)
library(kableExtra)
library(tidyverse)
library(gtsummary)
```

We will first extract the demographic variables from the 2015-2016 cycle. To check how the data table for this specific cycle has been coded on the CDC website, we can run the following chunk which queries the database and returns the associated name of the data group associated with the 2015 - 2016 survey cycle using the `nhanesTables()` function. For more info, you can type `?nhanesTables()` in the console to get a more detailed review of the function and how to use it.

```{r}
## demographic data 2015/2016
#race, gender, age, education level, marital status, income, religion, occupation, home ownership, 
kable(nhanesTables(data_group = 'DEMO', year = "2016"))
```

We now know that the demographic variables we are interested in acquiring are stored within the `DEMO_I` data group. We can then explicitly query the database for all demographic variables for this survey cycle using the following chunk. From the results, we are interested in the two-year survey weights for the cycle, `SDMVPSU` --	Masked variance unit pseudo-PSU variable for variance estimation, `SDMVSTRA`	-- Masked variance unit pseudo-stratum variable for variance estimation, all of which we need to work with the complex survey design aspect of the survey. We also include `SEQN` which unquely identifies a respondent to be able to link the files together for each individual. In addition, we will extract variables related to race, gender, age, education level, marital status, the number of reported children aged below 5 years, and income range. We have added education level, marital status, and income range while thinking about the possibility of confounding by these variables.

```{r}
## get the descriptions of all the demographic variables in nhanes 2015/2016
kable(nhanesTableVars(data_group = "DEMO", nh_table = "DEMO_I"), format = "latex")%>% 
  kable_styling(latex_options = c("scale_down"))
```


## Extracting NHANES 2015/16 cycle

Here, we extract the variables of interest in the NHANES dataset for the 2015/2016 cycle. All variables are based on the reports in the paper in the methods section. While there might be an easier way to work with these data, the variables here are extracted step-by-step for each survey cycle. The CDC variable search tool can be helpful while thinking about getting information on what variables are available (https://wwwn.cdc.gov/nchs/nhanes/search/default.aspx).

```{r warning=FALSE, message=FALSE}
## select all demographic variables that might be of interest in the study
demo <- nhanes("DEMO_I")

## subset to only vars of interest
demo1 <- demo[,c("DMDCITZN", # citizenship status
                "DMDEDUC2", # highest grade/education level
                "DMDHHSZA", # children aged < 5 yrs
                "RIDRETH3", # reported race
                "SDMVPSU",  # unit psedudo psu
                "SDMVSTRA", # pseudo-stratum vriable
                "RIAGENDR", # gender of the participant
                "RIDAGEYR", # age in yrs
                "INDFMIN2", # total family income range
                "DMDMARTL",  # marital status
                "SEQN",     # resp. seq. number
                "WTINT2YR" # full two-year interview weights
                )]
demo_vars <- names(demo1)
demo2 <- nhanesTranslate("DEMO_I", demo_vars, data = demo1)

## alcohol use
alcohol <- nhanes("ALQ_I")
alcohol1 <- alcohol[, c("SEQN", "ALQ120Q")]
alc_var <- names(alcohol1)
alcohol2 <- nhanesTranslate("ALQ_I", alc_var, data = alcohol1)

## smoking: do you smoke now?
sm <- nhanes("SMQ_I")
sm1 <- sm[c("SEQN", "SMQ040")]
sm_vars <- names(sm1)
sm2 <- nhanesTranslate("SMQ_I", sm_vars, data = sm1)

## diabetes: have you ever been told you have diabetes?
db <- nhanes("DIQ_I")
db1 <- db[c("SEQN", "DIQ010")]
db_vars <- names(db1)
db2 <- nhanesTranslate("DIQ_I", db_vars, data = db1)

## hypertension:
bp <- nhanes("BPQ_I") %>% dplyr::select(SEQN, BPQ020)
bp_vars <- names(bp)
bp2 <-nhanesTranslate("BPQ_I", bp_vars, data = bp)

## use hypertensive medication (?) included in the exclusion criteria but not mentioned in the list of variables
hbp_med <- nhanes("BPQ_I")
hbp_med1 <- hbp_med[c("SEQN", "BPQ050A")]
hbp_medvar <- names(hbp_med1)
hbp_med2 <- nhanesTranslate("BPQ_I", hbp_medvar, data = hbp_med1)

## snort/stop breathing
snort <- nhanes("SLQ_I")
snort1 <- snort[c("SEQN", "SLQ040")]
snort_vars <- names(snort1)
snort2 <- nhanesTranslate("SLQ_I", snort_vars, data = snort1)

## creatinine
creat <- nhanes("ALB_CR_I")
kable(nhanesTableVars(data_group = "LAB", nh_table = "ALB_CR_I"))
creat1 <- creat[c("SEQN", "URXCRS" # creatinine (umol/L)
                )]
creat_var <- names(creat1)
creat2 <- nhanesTranslate("ALB_CR_I", creat_var, data = creat1)

## albumin (g/L)
albu <- nhanes("BIOPRO_I")
albu1 <- albu[c("SEQN", "LBDSALSI", # albumin
                "LBXSASSI" # AST (U/L)
                )]
alb_vars <- names(albu1)
albu2 <- nhanesTranslate("BIOPRO_I", alb_vars, data = albu1)

## hemoglobin (g/dL)
hemo <- nhanes("CBC_I")
hemo1 <- hemo[c("SEQN", "LBXHGB")]
hemo_var <-names(hemo1)
hemo2 <- nhanesTranslate("CBC_I", hemo_var, data = hemo1)

## total cholestrol (TC mmol/L)
tc <- nhanes("TCHOL_I")
tc1 <- tc[c("SEQN", "LBDTCSI")]
tc_var <- names (tc1)
tc2 <- nhanesTranslate("TCHOL_I", tc_var, data = tc1)

## blood pressure (take three and average to get DBP in mmHg)
dbp <- nhanes("BPX_I")
dbp1 <- dbp[c("SEQN", "BPXDI1", "BPXDI2", "BPXDI3", "BPXDI4", # dbp
              "BPXSY1", "BPXSY2", "BPXSY3", "BPXSY4" # sbp
              )] # 1st, 2nd, and 3rd measurements
dbp_vars <- names(dbp1)
dbp2 <- nhanesTranslate("BPX_I", dbp_vars, data = dbp1)

## high density lipoprotein (HDL mmol/L)
hdl <- nhanes("HDL_I")
hdl1 <- hdl[c("SEQN", "LBDHDDSI")]
hdl_vars <- names(hdl1)
hdl2 <- nhanesTranslate("HDL_I", hdl_vars, data = hdl1)

## BMI (kg/m^2)
bmi <- nhanes("BMX_I")
bmi1 <- bmi[c("SEQN", "BMXBMI")]
bmi_var <- names(bmi1)
bmi2 <- nhanesTranslate("BMX_I", bmi_var, data = bmi1)

## sleep variable (number of hrs of sleep during weekdays or workdays) hrs
sleep <- nhanes("SLQ_I")
sleep1 <- sleep[c("SEQN", "SLD012")]
sleep_var <- names(sleep1)
sleep2 <- nhanesTranslate("SLQ_I", sleep_var, data = sleep1)

## combine all the files into one data frame
nhanes2015 <- plyr::join_all(list(sleep2, bmi2, hdl2, dbp2, tc2, hemo2, albu2, creat2, snort2, bp2, hbp_med2,  db2, sm2, alcohol2, demo2), by = "SEQN", type = "full")
dim(nhanes2015)
## save file
save(nhanes2015, file = "../Sleep and HBP/nhanes2015.RData")
```

We can then check the dimensions of the data we downloaded like in the chunk and note that we have 9971 observations on 34 variables. We have saved these data in our working directory for merging with the 2017/2018 cycle of the NHANES data which was also used in combination to the already downloaded data. 

```{r}
dim(nhanes2015)
```


## Extracting NHANES 2017/18 Cycle Data 

Here we extract the same variables for the 2017/2018 cycle and save the individuals and merged data files separately for analysis. We begin by querying the data to see its abbreviation in the 2017/2018 series. We are only interested in the same variables as the ones we have downloaded and therefore only query for these using the steps as seen above. 

```{r}
## clear the workspace
rm(list = ls())
## NHANES 2017/2018 cycle has abbreviation J.
kable(nhanesTables(data_group = 'DEMO', year = "2018"))
```

Now that we know the abbreviation used in the 2017/18 NHANES series, we can proceed to get the variables defined in the previous section. For the demographics, the variables available can be listed like so:

```{r}
## select all demographic variables that might be of interest in the study
demo <- nhanes("DEMO_J")
kable(nhanesTableVars(data_group = "DEMO", nh_table = "DEMO_J"), format = "latex") %>% 
  kable_styling(latex_options = c("scale_down"))
```


```{r warning=FALSE, message=FALSE}
## subset to only vars of interest
demo1 <- demo[,c("DMDCITZN", # citizenship status
                "DMDEDUC2", # highest grade/education level
                "DMDHHSZA", # children aged < 5 yrs
                "RIDRETH3", # reported race
                "SDMVPSU",  # unit psedudo psu
                "SDMVSTRA", # pseudo-stratum vriable
                "RIAGENDR", # gender of the participant
                "RIDAGEYR", # age in yrs
                "INDFMIN2", # total family income range
                "DMDMARTL",  # marital status
                "SEQN",     # resp. seq. number
                "WTINT2YR" # full two-year interview weights
                )]
demo_vars <- names(demo1)
demo2 <- nhanesTranslate("DEMO_J", demo_vars, data = demo1)

## alcohol use
alcohol <- nhanes("ALQ_J")
alcohol1 <- alcohol[, c("SEQN", "ALQ121")]
alc_var <- names(alcohol1)
alcohol2 <- nhanesTranslate("ALQ_J", alc_var, data = alcohol1)

## smoking: do you smoke now?
sm <- nhanes("SMQ_J")
sm1 <- sm[c("SEQN", "SMQ040")]
sm_vars <- names(sm1)
sm2 <- nhanesTranslate("SMQ_J", sm_vars, data = sm1)

## diabetes: have you ever been told you have diabetes?
db <- nhanes("DIQ_J")
db1 <- db[c("SEQN", "DIQ010")]
db_vars <- names(db1)
db2 <- nhanesTranslate("DIQ_J", db_vars, data = db1)

## hypertension:
bp <- nhanes("BPQ_J") %>% dplyr::select(SEQN, BPQ020)
bp_vars <- names(bp)
bp2 <-nhanesTranslate("BPQ_J", bp_vars, data = bp)

## use hypertensive medication (?) included in the exclusion criteria but not mentioned in the list of variables
hbp_med <- nhanes("BPQ_J")
hbp_med1 <- hbp_med[c("SEQN", "BPQ050A")]
hbp_medvar <- names(hbp_med1)
hbp_med2 <- nhanesTranslate("BPQ_J", hbp_medvar, data = hbp_med1)

## snort/stop breathing
snort <- nhanes("SLQ_J")
snort1 <- snort[c("SEQN", "SLQ040")]
snort_vars <- names(snort1)
snort2 <- nhanesTranslate("SLQ_J", snort_vars, data = snort1)

## creatinine
creat <- nhanes("ALB_CR_J")
kable(nhanesTableVars(data_group = "LAB", nh_table = "ALB_CR_J"))
creat1 <- creat[c("SEQN", "URXCRS" # creatinine (umol/L)
                )]
creat_var <- names(creat1)
creat2 <- nhanesTranslate("ALB_CR_J", creat_var, data = creat1)

## albumin (g/L)
albu <- nhanes("BIOPRO_J")
albu1 <- albu[c("SEQN", "LBDSALSI", # albumin
                "LBXSASSI" # AST (U/L)
                )]
alb_vars <- names(albu1)
albu2 <- nhanesTranslate("BIOPRO_J", alb_vars, data = albu1)

## hemoglobin (g/dL)
hemo <- nhanes("CBC_J")
hemo1 <- hemo[c("SEQN", "LBXHGB")]
hemo_var <-names(hemo1)
hemo2 <- nhanesTranslate("CBC_J", hemo_var, data = hemo1)

## total cholestrol (TC mmol/L)
tc <- nhanes("TCHOL_J")
tc1 <- tc[c("SEQN", "LBDTCSI")]
tc_var <- names (tc1)
tc2 <- nhanesTranslate("TCHOL_J", tc_var, data = tc1)

## blood pressure (take three and average to get DBP in mmHg)
dbp <- nhanes("BPX_J")
dbp1 <- dbp[c("SEQN", "BPXDI1", "BPXDI2", "BPXDI3", "BPXDI4",# dbp
              "BPXSY1", "BPXSY2", "BPXSY3", "BPXSY4" # sbp
              )] # 1st, 2nd, and 3rd measurements
dbp_vars <- names(dbp1)
dbp2 <- nhanesTranslate("BPX_J", dbp_vars, data = dbp1)

## high density lipoprotein (HDL mmol/L)
hdl <- nhanes("HDL_J")
hdl1 <- hdl[c("SEQN", "LBDHDDSI")]
hdl_vars <- names(hdl1)
hdl2 <- nhanesTranslate("HDL_J", hdl_vars, data = hdl1)

## BMI (kg/m^2)
bmi <- nhanes("BMX_J")
bmi1 <- bmi[c("SEQN", "BMXBMI")]
bmi_var <- names(bmi1)
bmi2 <- nhanesTranslate("BMX_J", bmi_var, data = bmi1)

## sleep variable (number of hrs of sleep during weekdays or workdays) hrs
sleep <- nhanes("SLQ_J")
sleep1 <- sleep[c("SEQN", "SLD012")]
sleep_var <- names(sleep1)
sleep2 <- nhanesTranslate("SLQ_J", sleep_var, data = sleep1)

## combine all the files into one data frame
nhanes2017 <- plyr::join_all(list(sleep2, bmi2, hdl2, dbp2, tc2, hemo2, albu2, creat2, snort2, bp2, hbp_med2,  db2, sm2, alcohol2, demo2), by = "SEQN", type = "full")
dim(nhanes2017)

## save the file to local computer
save(nhanes2017, file = "../Sleep and HBP/nhanes2017.RData")
```

The downloaded dataset has 9254 rows and 33 columns. We can then merge the data frames together after correcting any naming conflicts and attaching a survey cycle indicator. This can be useful when thinking about performing the same analysis stratified by the survey cycle to check, for example, if the same effects presented in the paper hold. 

```{r}
rm(list = ls())
# load the 2015 cycle and add an indicator of survey cycle
load("../Sleep and HBP/nhanes2015.RData")
load("../Sleep and HBP/nhanes2017.RData")
nhanes2015$cycle <- 0
nhanes2017$cycle <- 1

## check what names do not match between the two surveys
setdiff(names(nhanes2015), names(nhanes2017))

## only column ALQ120Q is not the same and we can change that label in the 2015 cycle to match and merge
nhanes2015 <- nhanes2015 %>% dplyr::rename(ALQ121 = ALQ120Q)

## we can confirm that the names are now identical
identical(names(nhanes2015), names(nhanes2017))

## append the two data files together
df <- rbind(nhanes2015, nhanes2017)

## get the dimension of combined file
dim(df)
```

Finally we have a working data set with more variables than in the original file so we can play around with it and we have the same sample size as in the paper. We can save the merged file together.

```{r}
## save all the three files
#save(df, file = "../Sleep and HBP/df.RData")
```


## Data preprocessing

Now that we have a dataset together, we can go ahead and clean the variables following the preprocessing steps employed in the paper. We begin by re-coding all the factor variables into the formats presented in the table. We first rename the variables into more reasonable identities. One thing about the variables that the paper does not mention is the question used to define use of hypertensive medication.

```{r}
## rename variable names
dt <- df %>% 
  dplyr::rename("seq_no" = SEQN, "psu" = SDMVPSU, "strata" = SDMVSTRA, "gender" = RIAGENDR, "age_yr" = RIDAGEYR, "marital_status" = DMDMARTL, "weights" = WTINT2YR, "income_range" = INDFMIN2, "race" = RIDRETH3, "children <5" = DMDHHSZA, "educ_level" = DMDEDUC2, "citizenship_status" = DMDCITZN, "sleep" = SLD012, "bmi" = BMXBMI, "alcohol" = ALQ121, "hdl" = LBDHDDSI, "albumin" = LBDSALSI, "diabetes" = DIQ010, "hypertension" = BPQ020, "creatinine" = URXCRS, "snort" = SLQ040, "total_chol" = LBDTCSI,"hemoglobin" = LBXHGB, "AST" = LBXSASSI, "smoke" = SMQ040, "hyper_meds" = BPQ050A)

## drop missing sleep values
dt <- dt %>% tidyr::drop_na(sleep)
dim(dt)

## combine the systolic and diastolic blood pressure by averaging the four measurements available
dt$dbp <- rowMeans(subset(dt, select = c(BPXDI1, BPXDI2, BPXDI3, BPXDI4)), na.rm = TRUE)
dt$sbp <- rowMeans(subset(dt, select = c(BPXSY1, BPXSY2, BPXSY3, BPXSY4)), na.rm = TRUE)

## we can then delete the variables related to dbp and sbp from the data set and drop missing values for either dbp or sbp
dt <- dt %>% dplyr::select(-c(BPXDI1, BPXDI2, BPXDI3, BPXDI4, BPXSY1, BPXSY2, BPXSY3, BPXSY4)) %>% 
  tidyr::drop_na(dbp, sbp)
dim(dt)

## then we exclude individuals on antihypertension meds
dt = dt %>% dplyr::filter(is.na(hyper_meds)|hyper_meds == "No")
dim(dt)
## we also need to exclude individuals with missing BMI and then finally subset to only underweight or obese
dt <- dt %>% tidyr::drop_na(bmi) %>% 
  dplyr::filter(bmi < 25)
dim(dt)

## we can save this files for use later
#save(dt, file = "../Sleep and HBP/cleaned_df.RData")
```


Now that we have filtered the data to have the same sample size as used in the paper and also followed the prescribed exclusion criteria, we can go on and clean up the categories of the categorical variables so that they match what has been presented in the paper or are at least reasonable enough. Not the categorizations for the alcohol variable differ from what was presented in the paper since the variable was differently measured across survey cycles. 

```{r include=FALSE}
## sleep duration
dt$sleep2 <- as.factor(ifelse(dt$sleep < 6, "<6hrs", 
                              ifelse((dt$sleep >= 6) & (dt$sleep < 8), "6-8hrs", ">8hrs")))
  
#race
table(dt$race)
dt$race2 <- as.factor(ifelse(dt$race == "Mexican American", "Mexican American",
                            ifelse(dt$race == "Non-Hispanic White", "White",
                                   ifelse(dt$race == "Non-Hispanic Black", "Black", "Other"))))
## smoking
dt$smoke2 <- as.factor(ifelse(dt$smoke == "Every day" | dt$smoke == "Some days", "Smoking",
                               ifelse(dt$smoke == "Not at all", "Not smoking", "Not recorded")))

## diabetes
table(dt$diabetes)

## hypertension
table(dt$hypertension)

## snort
table(dt$snort)
dt$snort2 <- as.factor(ifelse(dt$snort == "Never", "No",
                             ifelse(dt$snort == "Rarely - 1-2 nights a week"| dt$snort == "Occasionally - 3-4 nights a week" | dt$snort == "Frequently - 5 or more nights a", "Yes", "Not recorded")))

## gender
table(dt$gender)

## alcohol consumption
table(dt$alcohol, useNA = "ifany")
dt[dt == 999] <- NA ## convert missing to NA
## assume individuals with 0 drinks have never drank and all others with info have drank, and then we have NA
dt$alcohol2 <- as.factor(ifelse(dt$alcohol == 0, "No drinking", 
                                ifelse(is.na(dt$alcohol), "Not recorded", "Drinking")))
table(dt$alcohol2)
```


## Table 1 Replication

The table below shows our sample replication. Even though weights are not used in this table, we perform pretty well. The p-values show effects in the same direction as those reported in the paper except for age, alcohol consumption, sleep and smoking status. Overall, replicating this paper was relatively difficult considering no information is presented in the paper about variables they used; given that some variables occur multiply across the cycles. This could have had the effect of reducing the quality of these replication. An extension could consider adding a survey cycle indicator, including some of the additional confounding variables into the fitted model and seeing how the results change.

```{r}
## select the variables in Table 1
dt2 <- dt %>% dplyr::select(age_yr, albumin, creatinine, sbp, dbp, hemoglobin, total_chol, AST, hdl, bmi, alcohol2, diabetes, hypertension, snort2, smoke2, race2, sleep2, gender)
#str(dt2)

table1 <- dt2 %>% gtsummary::tbl_summary(by = gender,
                                 statistic = list(all_continuous() ~ "{mean} ({sd})", 
                                          all_categorical() ~ "{p}"),
                         percent = "column",
                         missing = "no") %>% 
  bold_labels() %>% 
  add_overall() %>% 
  add_p() %>% 
  as_kable(format = "pipe", caption = "Baseline participant characteristics", digits = 2) #%>% 
  #kable_styling(latex_options = "scale_down")
table1
```




